{# dashboard_admin/templates/dashboard_admin/ver_pedidos.html #}
{% extends 'dashboard_admin/dashboard_base.html' %}
{% load static %}

{% block title %}Ver Pedidos{% endblock %}

{% block dashboard_content %}
<style>
    /* --- Estilos Personalizados para la página de Pedidos --- */
    
    .card-pedidos {
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .card-header-pedidos {
        background-color: #343a40; /* Color oscuro */
        color: #ffffff;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 20px -20px;
        text-align: center;
    }

    .card-header-pedidos h6 {
        margin: 0;
        font-size: 1.25rem;
    }

    .table-pedidos {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .table-pedidos th, .table-pedidos td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .table-pedidos th {
        background-color: #f8f9fa;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: #6c757d;
    }

    .table-pedidos tbody tr:hover {
        background-color: #f1f1f1;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .badge-success { background-color: #28a745; color: white; }
    .badge-danger { background-color: #dc3545; color: white; }
    .badge-warning { background-color: #ffc107; color: #343a40; }

    .btn-detalles {
        background-color: #17a2b8;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s;
    }

    .btn-detalles:hover {
        background-color: #138496;
    }

    .btn-factura {
        background-color: #007bff; /* Un color azul para distinguirlo */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s;
    }

    .btn-factura:hover {
        background-color: #0056b3;
    }

    .text-truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- Estilos para la Paginación --- */
    .pagination {
        display: flex;
        list-style: none;
        padding: 0;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination a, .pagination .page-item {
        margin: 0 5px;
        text-decoration: none;
        color: #007bff;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        border-radius: 5px;
        transition: background-color 0.3s, color 0.3s;
    }

    .pagination a:hover {
        background-color: #e9ecef;
    }

    .pagination .disabled {
        color: #6c757d;
        cursor: not-allowed;
    }

    /* --- Estilos para los Modales (sin Bootstrap) --- */
    .custom-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; /* Por defecto oculto */
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    .custom-modal-content {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        padding: 20px;
        max-width: 500px;
        width: 90%;
        position: relative;
    }

    .custom-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .custom-modal-header h5 {
        margin: 0;
    }

    .custom-modal-close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        line-height: 1;
        cursor: pointer;
        color: #6c757d;
    }

    .custom-modal-footer {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
        margin-top: 15px;
        text-align: right;
    }

    .list-group {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .list-group-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
    }
    
    .list-group-item:last-child {
        border-bottom: none;
    }
</style>

<div class="container-fluid-custom py-4">
    <h1 class="content-title">Pedidos de Clientes</h1>
    
    <div class="row">
        <div class="col-12">
            <div class="card-pedidos">
                <div class="card-header-pedidos">
                    <h6 class="text-white text-capitalize">Lista de Pedidos</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table-pedidos">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Fecha de Pedido</th>
                                    <th>Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pedido in page_obj %}
                                <tr>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">#{{ pedido.pk }}</p>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">{{ pedido.nombre }} ({{ pedido.usuario.username }})</p>
                                        <p class="text-xs text-secondary mb-0">Envío a: {{ pedido.direccion }}, {{ pedido.ciudad }}</p>
                                    </td>
                                    <td>
                                        <p class="text-xs font-weight-bold mb-0">${{ pedido.total_pedido|floatformat:2 }}</p>
                                    </td>
                                    <td>
                                        {% if pedido.estado == 'Completado' %}
                                            <span class="badge badge-success">{{ pedido.estado }}</span>
                                        {% elif pedido.estado == 'Cancelado' %}
                                            <span class="badge badge-danger">{{ pedido.estado }}</span>
                                        {% else %}
                                            <span class="badge badge-warning">{{ pedido.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="align-middle">
                                        <span class="text-secondary text-xs font-weight-bold">{{ pedido.fecha_creacion|date:"d M Y H:i" }}</span>
                                    </td>
                                    <td class="align-middle">
                                        <button class="btn-detalles" onclick="showModal('pedidoModal-{{ pedido.pk }}')">
                                            Ver Productos
                                        </button>
                                        <!-- NUEVO BOTÓN para descargar la factura -->
                                        <a href="{% url 'dashboard_admin:descargar_factura' pedido.id %}" class="btn-factura">
                                            <i class="fas fa-file-pdf"></i> Factura
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# MODALES con JavaScript puro #}
    {% for pedido in page_obj %}
    <div class="custom-modal-backdrop" id="pedidoModal-{{ pedido.pk }}">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h5 class="custom-modal-title">Productos del Pedido #{{ pedido.pk }}</h5>
                <button class="custom-modal-close-btn" onclick="hideModal('pedidoModal-{{ pedido.pk }}')">&times;</button>
            </div>
            <div class="custom-modal-body">
                <ul class="list-group">
                    {% for item in pedido.items.all %}
                        <li class="list-group-item">
                            <span>{{ item.cantidad }} x {{ item.producto.nombre }}</span>
                            <span>${{ item.precio_unitario|floatformat:2 }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="custom-modal-footer">
                <button class="btn-detalles" onclick="hideModal('pedidoModal-{{ pedido.pk }}')">Cerrar</button>
            </div>
        </div>
    </div>
    {% endfor %}

    {# Paginación #}
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item"><a href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
            {% endif %}
            <li class="page-item disabled">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</li>
            {% if page_obj.has_next %}
                <li class="page-item"><a href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>
            {% endif %}
        </ul>
    </nav>
</div>

<script>
    function showModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function hideModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock dashboard_content %}
